#!/bin/sh

set -eu

builddir='@TEST_BUILD_DIR@'
timeout_s='@TEST_TIMEOUT_S@'
openbox_bin="${OPENBOX_TEST_BINARY:-@OPENBOX_BIN@}"
host_display="${DISPLAY:-}"
test_display="${OPENBOX_TEST_DISPLAY:-:1}"
test_screen="${OPENBOX_TEST_SCREEN:-1024x768x24}"
started_xephyr=0
started_xvfb=0
found_any=0
failed=0
ob_pid=''
xephyr_pid=''

if ! command -v xprop >/dev/null 2>&1; then
  echo "Skipping X11 regression tests: xprop is not available."
  exit 77
fi

run_one() {
  bin=$1
  printf 'Running %s\n' "$(basename "$bin")"
  if command -v timeout >/dev/null 2>&1; then
    if ! timeout "$timeout_s" "$bin"; then
      status=$?
      [ "$status" -eq 77 ] && return 0
      echo "Test $bin failed with status $status" >&2
      return "$status"
    fi
  else
    if ! "$bin"; then
      status=$?
      [ "$status" -eq 77 ] && return 0
      echo "Test $bin failed with status $status" >&2
      return "$status"
    fi
  fi
}

start_xvfb() {
  Xvfb "$test_display" -screen 0 "$test_screen" -nolisten tcp >/dev/null 2>&1 &
  xvfb_pid=$!

  for _ in $(seq 1 50); do
    if DISPLAY="$test_display" xprop -root >/dev/null 2>&1; then
      started_xvfb=1
      return 0
    fi
    sleep 0.1
  done

  echo "Xvfb on $test_display did not become ready." >&2
  return 1
}

start_xephyr() {
  if [ -z "$host_display" ]; then
    return 1
  fi
  DISPLAY="$host_display" Xephyr "$test_display" -screen "$test_screen" -nolisten tcp -terminate -reset -ac >/dev/null 2>&1 &
  xephyr_pid=$!

  for _ in $(seq 1 50); do
    if DISPLAY="$test_display" xprop -root >/dev/null 2>&1; then
      started_xephyr=1
      return 0
    fi
    sleep 0.1
  done

  echo "Xephyr on $test_display did not become ready." >&2
  return 1
}

cleanup() {
  if [ -n "${ob_pid:-}" ] && kill -0 "$ob_pid" 2>/dev/null; then
    kill "$ob_pid" 2>/dev/null || true
    wait "$ob_pid" 2>/dev/null || true
  fi
  if [ "${started_xephyr:-0}" -eq 1 ] && [ -n "${xephyr_pid:-}" ]; then
    if kill -0 "$xephyr_pid" 2>/dev/null; then
      kill "$xephyr_pid" 2>/dev/null || true
    fi
    wait "$xephyr_pid" 2>/dev/null || true
  fi
  if [ "${started_xvfb:-0}" -eq 1 ] && [ -n "${xvfb_pid:-}" ]; then
    if kill -0 "$xvfb_pid" 2>/dev/null; then
      kill "$xvfb_pid" 2>/dev/null || true
    fi
    wait "$xvfb_pid" 2>/dev/null || true
  fi
}
trap cleanup EXIT INT TERM

if ! DISPLAY="$test_display" xprop -root >/dev/null 2>&1; then
  if command -v Xvfb >/dev/null 2>&1; then
    if ! start_xvfb; then
      echo "Skipping X11 regression tests: unable to start Xvfb on $test_display." >&2
      exit 77
    fi
  elif command -v Xephyr >/dev/null 2>&1; then
    if ! start_xephyr; then
      echo "Skipping X11 regression tests: unable to start Xephyr on $test_display." >&2
      exit 77
    fi
  else
    echo "Skipping X11 regression tests: Xvfb and Xephyr are not available."
    exit 77
  fi
fi
DISPLAY="$test_display"
export DISPLAY

gdb_commands_path="@GDB_COMMANDS_PATH@"

startup_openbox() {
  # ASAN_OPTIONS is disabled when GDB is active.
  # export ASAN_OPTIONS="log_path=$builddir/asan.log:halt_on_error=1:abort_on_error=1:print_summary=1"
  gdb -batch -x "$gdb_commands_path" --args "${openbox_bin}" --replace --sm-disable >"$builddir/openbox-test.log" 2>"$builddir/openbox-gdb.log" &
  ob_pid=$!

  for _ in $(seq 1 50); do
    if xprop -root _NET_SUPPORTING_WM_CHECK >/dev/null 2>&1; then
      return 0
    fi
    sleep 0.1
  done

  echo "Openbox did not signal readiness via _NET_SUPPORTING_WM_CHECK" >&2
  return 1
}

startup_openbox

if [ -f "$builddir/openbox-gdb.log" ]; then
  echo "--- GDB Log Start ---"
  cat "$builddir/openbox-gdb.log"
  echo "--- GDB Log End ---"
fi

for bin in "$builddir"/test-*; do
  if [ ! -x "$bin" ]; then
    continue
  fi
  # Skip meson private directories
  case "$bin" in
    *.p) continue ;;
  esac
  found_any=1
  if ! run_one "$bin"; then
    failed=1
  fi
done

if [ "$found_any" -eq 0 ]; then
  echo "No X11 regression test binaries found in $builddir" >&2
  exit 1
fi

exit "$failed"
