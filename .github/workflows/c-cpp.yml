name: CI

# run on every push to any branch, on PRs, and manually
on:
  push:
  pull_request:
  workflow_dispatch:

# minimal token permissions for checkout
permissions:
  contents: read

jobs:
  build-and-test:
    strategy:
      matrix:
        sanitizer:
          - none
          - asan-ubsan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4.1.6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential meson ninja-build pkg-config gettext docbook-to-man \
            clang gcc \
            libx11-dev libxext-dev libxrender-dev libpango1.0-dev libglib2.0-dev \
            libstartup-notification0-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libimlib2-dev librsvg2-dev libxml2-dev \
            xvfb x11-utils dbus-x11

      - name: Prepare runtime suppressions
        run: |
          mkdir -p .github
          printf 'leak:XOpenDisplay\nleak:FcInit\n' > .github/lsan.supp

      - name: Configure & build
        shell: bash
        run: |
          set -euo pipefail
          rm -rf build install-root
          setup_args=()
          if [ "${{ matrix.sanitizer }}" = "asan-ubsan" ]; then
            export CC=clang
            setup_args+=("-Db_sanitize=address,undefined" "-Db_lundef=false")
          else
            export CC=gcc
          fi
          meson setup build \
            --prefix=/usr \
            --sysconfdir=/etc \
            --localstatedir=/var \
            "${setup_args[@]}"
          meson compile -C build
          meson test -C build --print-errorlogs
          meson compile -C build x11-regression-tests
          meson install -C build --destdir="$PWD/install-root"

      - name: Launch Xvfb and run tests
        shell: bash
        run: |
          set -euo pipefail
          sudo Xvfb :99 -screen 0 1280x800x24 -nolisten tcp &
          export DISPLAY=:99
          for i in {1..20}; do
            if xdpyinfo -display "$DISPLAY" >/dev/null 2>&1; then
              break
            fi
            sleep 0.25
          done

          dbus-run-session -- bash -lc '
            set -euo pipefail

            export PATH="$GITHUB_WORKSPACE/install-root/usr/bin:$PATH"
            export XDG_DATA_DIRS="$GITHUB_WORKSPACE/install-root/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
            libdir_root="$GITHUB_WORKSPACE/install-root/usr/lib"
            libdir_multi="$GITHUB_WORKSPACE/install-root/usr/lib/x86_64-linux-gnu"
            ld_path="$libdir_root"
            if [ -d "$libdir_multi" ]; then
              ld_path="$libdir_multi:$ld_path"
            fi
            if [ -n "${LD_LIBRARY_PATH:-}" ]; then
              ld_path="$ld_path:$LD_LIBRARY_PATH"
            fi
            export LD_LIBRARY_PATH="$ld_path"

            openbox --replace >/tmp/openbox.log 2>&1 &
            for i in {1..50}; do
              if xprop -root _NET_SUPPORTING_WM_CHECK >/dev/null 2>&1; then
                break
              fi
              sleep 0.1
            done

            cd "$GITHUB_WORKSPACE/build/tests"

            run_with_timeout() {
              timeout 10s "$@"
              status=$?
              if [ $status -eq 124 ]; then
                echo "[Timeout] Killed test after 10 seconds"
              elif [ $status -ne 0 ]; then
                echo "[Error] Test failed with status $status"
              fi
              return $status
            }

            mapfile -t test_bins < <(find . -maxdepth 1 -type f -perm -111 \
              -name "test-*" -printf "%P\n" | sort)

            overall_status=0

            if [ "${{ matrix.sanitizer }}" = "asan-ubsan" ]; then
              export ASAN_OPTIONS=detect_leaks=1:halt_on_error=1:detect_odr_violation=1:strict_init_order=1
              export UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1
              export LSAN_OPTIONS="suppressions=$GITHUB_WORKSPACE/.github/lsan.supp:print_suppressions=0"
              for t in "${test_bins[@]}"; do
                echo "[ASan/UBSan] Running $t..."
                if ! run_with_timeout "./$t"; then
                  overall_status=1
                fi
              done
            else
              for t in "${test_bins[@]}"; do
                echo "[Normal] Running $t..."
                if ! run_with_timeout "./$t"; then
                  overall_status=1
                fi
              done
            fi

            exit $overall_status
          '
