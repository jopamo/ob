name: CI

# run on every push to any branch, on PRs, and manually
on:
  push:
  pull_request:
  workflow_dispatch:

# minimal token permissions for checkout
permissions:
  contents: read

jobs:
  build-and-test:
    strategy:
      matrix:
        sanitizer:
          - none
          - asan-ubsan
          - valgrind
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4.1.6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential meson ninja-build pkg-config gettext docbook-to-man \
            clang gcc valgrind \
            libx11-dev libxext-dev libxrender-dev libpango1.0-dev libglib2.0-dev \
            libstartup-notification0-dev libxrandr-dev libxinerama-dev \
            libxcursor-dev libimlib2-dev librsvg2-dev libxml2-dev \
            xvfb x11-utils dbus-x11

      - name: Prepare runtime suppressions
        run: |
          mkdir -p .github
          printf 'leak:XOpenDisplay\nleak:FcInit\n' > .github/lsan.supp

      - name: Configure & build
        shell: bash
        run: |
          set -euo pipefail
          rm -rf build install-root
          setup_args=()
          if [ "${{ matrix.sanitizer }}" = "asan-ubsan" ]; then
            export CC=clang
            setup_args+=("-Db_sanitize=address,undefined" "-Db_lundef=false")
          else
            export CC=gcc
          fi
          meson setup build \
            --prefix=/usr \
            --sysconfdir=/etc \
            --localstatedir=/var \
            "${setup_args[@]}"
          meson compile -C build
          meson test -C build --print-errorlogs
          meson install -C build --destdir="$PWD/install-root"

      - name: Launch Xvfb and run tests
        shell: bash
        run: |
          set -euo pipefail
          dbus-run-session -- xvfb-run --auto-servernum --server-args="-screen 0 1280x800x24 -nolisten tcp" bash -lc '
            set -euo pipefail

            # helpful glib settings under valgrind
            export G_DEBUG=gc-friendly
            export G_SLICE=always-malloc

            export PATH="$GITHUB_WORKSPACE/install-root/usr/bin:$PATH"
            export XDG_DATA_DIRS="$GITHUB_WORKSPACE/install-root/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
            libdir_root="$GITHUB_WORKSPACE/install-root/usr/lib"
            libdir_multi="$GITHUB_WORKSPACE/install-root/usr/lib/x86_64-linux-gnu"
            ld_path="$libdir_root"
            if [ -d "$libdir_multi" ]; then
              ld_path="$libdir_multi:$ld_path"
            fi
            if [ -n "${LD_LIBRARY_PATH:-}" ]; then
              ld_path="$ld_path:$LD_LIBRARY_PATH"
            fi
            export LD_LIBRARY_PATH="$ld_path"

            export OPENBOX_TEST_BINARY="$GITHUB_WORKSPACE/install-root/usr/bin/openbox"

            if [ "${{ matrix.sanitizer }}" = "asan-ubsan" ]; then
              export ASAN_OPTIONS=detect_leaks=1:halt_on_error=1:detect_odr_violation=1:strict_init_order=1
              export UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1
              export LSAN_OPTIONS="suppressions=$GITHUB_WORKSPACE/.github/lsan.supp:print_suppressions=0"
              export OPENBOX_TEST_WRAPPER=""
            elif [ "${{ matrix.sanitizer }}" = "valgrind" ]; then
              export OPENBOX_TEST_WRAPPER="valgrind --quiet --error-exitcode=1 --leak-check=full --show-leak-kinds=all --errors-for-leak-kinds=definite --track-origins=yes"
            else
              export OPENBOX_TEST_WRAPPER=""
            fi

            meson test -C "$GITHUB_WORKSPACE/build" --suite x11 --print-errorlogs --no-rebuild
          '
